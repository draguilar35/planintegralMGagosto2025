<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Plan de Bienestar Integral</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
            color: #334155;
        }
        .container {
            max-width: 900px;
        }
        .card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }
        .header {
            background-color: #2563eb;
            color: #ffffff;
            border-radius: 1rem 1rem 0 0;
        }
        .btn-check {
            border: 2px solid #6b7280;
            border-radius: 0.25rem;
            width: 24px;
            height: 24px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .btn-check:hover {
            background-color: #e2e8f0;
        }
        .btn-check.checked {
            background-color: #22c55e;
            border-color: #22c55e;
            transform: scale(1.1);
        }
        .grid-checkboxes {
            grid-template-columns: repeat(7, minmax(0, 1fr));
        }
        @media (max-width: 640px) {
            .grid-checkboxes {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }
        .section-title {
            position: relative;
        }
        .section-title::before {
            content: '';
            position: absolute;
            left: 0;
            bottom: -5px;
            width: 50px;
            height: 4px;
            background-color: #60a5fa;
            border-radius: 2px;
        }
        .chat-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .user-message {
            background-color: #e2e8f0;
            border-radius: 0.75rem;
            padding: 0.5rem 1rem;
        }
        .gemini-message {
            background-color: #d1fae5;
            border-radius: 0.75rem;
            padding: 0.5rem 1rem;
        }
        .speak-btn {
            background-color: #0c4a6e;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .speak-btn:hover {
            background-color: #155e75;
        }
        .loading-dot {
            animation: bounce 1s infinite;
        }
        .loading-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            0%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-5px);
            }
        }
    </style>
</head>
<body class="p-6 md:p-10">
    <div class="container mx-auto">
        <div class="card overflow-hidden">
            <header class="header p-6 md:p-8">
                <h1 class="text-3xl md:text-4xl font-bold mb-2">Mi Plan de Bienestar Integral</h1>
                <p class="text-lg md:text-xl font-light">Agosto 2025</p>
            </header>
            <main class="p-6 md:p-8">
                
                <!-- Suplementos y Medicamentos -->
                <section class="mb-8">
                    <h2 class="section-title text-2xl font-semibold mb-4 text-sky-800">Suplementos y Medicamentos</h2>
                    <div class="space-y-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-semibold text-lg">üíä Omega 3</p>
                            <p class="text-sm">2 c√°psulas con las 3 comidas principales. Permanente hasta nuevo aviso.</p>
                            <p class="mt-2 text-green-700 font-medium">‚û°Ô∏è Mejor momento: **Durante o inmediatamente despu√©s de cada comida.**</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-semibold text-lg">üíä Coenzima Q10 (300mg) y Belle Vie (2 c√°psulas)</p>
                            <p class="text-sm">Tomar diariamente.</p>
                            <p class="mt-2 text-green-700 font-medium">‚û°Ô∏è Mejor momento: **Durante o despu√©s de la comida m√°s grande del d√≠a (idealmente almuerzo).**</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-semibold text-lg">üíä Cardo Mariano o Milk Thistle</p>
                            <p class="text-sm">Tomar despu√©s de cada comida.</p>
                            <p class="mt-2 text-green-700 font-medium">‚û°Ô∏è Mejor momento: **Despu√©s de cada comida, como indica el plan.**</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-semibold text-lg">üíä Resveratrol</p>
                            <p class="text-sm">Tomar por 1 mes m√°s y luego suspender.</p>
                            <p class="mt-2 text-green-700 font-medium">‚û°Ô∏è Mejor momento: **Con una comida (almuerzo o cena).**</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-semibold text-lg">üíä Vit D3 (4000UI) + K2</p>
                            <p class="text-sm">Tomar diariamente.</p>
                            <p class="mt-2 text-green-700 font-medium">‚û°Ô∏è Mejor momento: **Con la comida principal del d√≠a que contenga grasas.**</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-semibold text-lg">üíä Ashwagandha en polvo</p>
                            <p class="text-sm">1g por la ma√±ana y 2g por la noche.</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-semibold text-lg">üíä Terapia de Bach</p>
                            <p class="text-sm">4 gotas cada 2 horas.</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-semibold text-lg">üíä Otros</p>
                            <p class="text-sm">Tomar Triplix 3 d√≠as por semana. Benicar 20/12.5 cada d√≠a a las 11:30am.</p>
                        </div>
                        <div class="bg-red-50 p-4 rounded-lg">
                            <p class="font-semibold text-lg text-red-700">‚ö†Ô∏è Suspendidos</p>
                            <p class="text-sm">‚ùå Bisglicinato de Magnesio</p>
                            <p class="text-sm">‚ùå Estatinas (hasta nuevos ex√°menes)</p>
                            <p class="text-sm">‚ùå Citrato de potasio (al terminar el que tiene)</p>
                            <p class="text-sm">‚ùå Rhodiola</p>
                        </div>
                    </div>
                </section>

                <!-- Plan de Ejercicio -->
                <section class="mb-8">
                    <h2 class="section-title text-2xl font-semibold mb-4 text-sky-800">Plan de Ejercicio</h2>
                    <p class="text-sm italic mb-4 text-gray-600">Recuerda: ¬°La clave es moverse sin dolor! Escucha a tu cuerpo siempre.</p>
                    <div class="space-y-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-semibold text-lg flex items-center justify-between">
                                <span>üí™ Fuerza (3 veces/semana)</span>
                            </p>
                            <ul class="list-disc list-inside space-y-2 mt-2">
                                <li class="flex items-center justify-between">
                                    <span>**Sentadillas:** 3 series de 10-12 repeticiones (usa una silla para seguridad).</span>
                                    <button class="speak-btn ml-2" data-text="Sentadillas: Realiza 3 series de 10 a 12 repeticiones. Puedes usar una silla para mayor seguridad." aria-label="Escuchar instrucciones"><span class="mr-1">üîä</span><span class="text-xs">Escuchar</span></button>
                                </li>
                                <li class="flex items-center justify-between">
                                    <span>**Press de hombros:** 3 series de 10 repeticiones. (<a href="https://youtu.be/snQ4FhucZMI" target="_blank" class="text-blue-600 underline">Ver video</a>)</span>
                                    <button class="speak-btn ml-2" data-text="Press de hombros: Realiza 3 series de 10 repeticiones." aria-label="Escuchar instrucciones"><span class="mr-1">üîä</span><span class="text-xs">Escuchar</span></button>
                                </li>
                                <li class="flex items-center justify-between">
                                    <span>**Ejercicios con banda el√°stica:** Realiza los ejercicios del video. (<a href="https://youtu.be/XX141kTNqg4" target="_blank" class="text-blue-600 underline">Ver video</a>)</span>
                                    <button class="speak-btn ml-2" data-text="Ejercicios con banda el√°stica: Realiza todos los ejercicios del video, o solo una parte si lo prefieres." aria-label="Escuchar instrucciones"><span class="mr-1">üîä</span><span class="text-xs">Escuchar</span></button>
                                </li>
                            </ul>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-semibold text-lg flex items-center justify-between">
                                <span>üèÉ‚Äç‚ôÄÔ∏è Cardiovascular (3-4 veces/semana)</span>
                            </p>
                            <ul class="list-disc list-inside space-y-2 mt-2">
                                <li class="flex items-center justify-between">
                                    <span>**Caminata r√°pida:** 20 minutos diarios por 4 d√≠as a la semana.</span>
                                    <button class="speak-btn ml-2" data-text="Caminata r√°pida: Realiza 20 minutos de caminata r√°pida 4 d√≠as a la semana." aria-label="Escuchar instrucciones"><span class="mr-1">üîä</span><span class="text-xs">Escuchar</span></button>
                                </li>
                                <li class="flex items-center justify-between">
                                    <span>**Bicicleta est√°tica:** Intercalar con la caminata si es posible.</span>
                                    <button class="speak-btn ml-2" data-text="Bicicleta est√°tica: Puedes intercalar este ejercicio con la caminata si tienes una." aria-label="Escuchar instrucciones"><span class="mr-1">üîä</span><span class="text-xs">Escuchar</span></button>
                                </li>
                            </ul>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-semibold text-lg flex items-center justify-between">
                                <span>üßò‚Äç‚ôÄÔ∏è Movilidad y Flexibilidad (todos los d√≠as)</span>
                            </p>
                            <ul class="list-disc list-inside space-y-2 mt-2">
                                <li class="flex items-center justify-between">
                                    <span>**Tocar la punta de los pies:** Sentada con piernas extendidas, 30 segundos.</span>
                                    <button class="speak-btn ml-2" data-text="Tocar la punta de los pies: Si√©ntate en el piso con las piernas extendidas e intenta tocarte la punta de los pies. Mant√©n la posici√≥n por 30 segundos." aria-label="Escuchar instrucciones"><span class="mr-1">üîä</span><span class="text-xs">Escuchar</span></button>
                                </li>
                                <li class="flex items-center justify-between">
                                    <span>**Llevar un pie al gl√∫teo:** De pie, 20-30 segundos por lado.</span>
                                    <button class="speak-btn ml-2" data-text="Llevar un pie al gl√∫teo: De pie, toma un pie y ll√©valo hacia el gl√∫teo. Mant√©n esta postura de 20 a 30 segundos por cada lado." aria-label="Escuchar instrucciones"><span class="mr-1">üîä</span><span class="text-xs">Escuchar</span></button>
                                </li>
                                <li class="flex items-center justify-between">
                                    <span>**Rodillas al pecho:** Acostada, 30 segundos.</span>
                                    <button class="speak-btn ml-2" data-text="Rodillas al pecho: Acu√©state y lleva las rodillas lo m√°s que puedas al pecho. Mant√©n esta posici√≥n por 30 segundos." aria-label="Escuchar instrucciones"><span class="mr-1">üîä</span><span class="text-xs">Escuchar</span></button>
                                </li>
                            </ul>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-semibold text-lg flex items-center justify-between">
                                <span>‚ú® Ejercicios Suaves para Espalda y Rodillas</span>
                            </p>
                            <ul class="list-disc list-inside space-y-2 mt-2">
                                <li class="flex items-center justify-between">
                                    <span>**Gato-Vaca Sentada:** 5-8 repeticiones. (<a href="https://youtu.be/Evp3n817pGk" target="_blank" class="text-blue-600 underline">Ver video</a>)</span>
                                    <button class="speak-btn ml-2" data-text="Gato-Vaca Sentada: Repite este ciclo de forma lenta de 5 a 8 veces." aria-label="Escuchar instrucciones"><span class="mr-1">üîä</span><span class="text-xs">Escuchar</span></button>
                                </li>
                                <li class="flex items-center justify-between">
                                    <span>**Extensi√≥n de Pierna Sentada:** 8-10 repeticiones por pierna. (<a href="https://youtu.be/M5-x2t3Ya2l" target="_blank" class="text-blue-600 underline">Ver video</a>)</span>
                                    <button class="speak-btn ml-2" data-text="Extensi√≥n de Pierna Sentada: Repite de 8 a 10 veces con cada pierna." aria-label="Escuchar instrucciones"><span class="mr-1">üîä</span><span class="text-xs">Escuchar</span></button>
                                </li>
                                <li class="flex items-center justify-between">
                                    <span>**Puente de Gl√∫teos:** 5-8 repeticiones. (<a href="https://youtu.be/f-R-gAg_D2A" target="_blank" class="text-blue-600 underline">Ver video</a>)</span>
                                    <button class="speak-btn ml-2" data-text="Puente de Gl√∫teos: Repite de 5 a 8 veces." aria-label="Escuchar instrucciones"><span class="mr-1">üîä</span><span class="text-xs">Escuchar</span></button>
                                </li>
                            </ul>
                        </div>
                    </div>
                </section>

                <!-- H√°bitos y Bienestar -->
                <section class="mb-8">
                    <h2 class="section-title text-2xl font-semibold mb-4 text-sky-800">H√°bitos y Bienestar</h2>
                    <div class="space-y-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-semibold text-lg">üõÅ Ba√±os con sales de Epsom</p>
                            <p class="text-sm">Media taza de sales de Epsom por cada 2 o 3 litros de agua. Realizarlos con agua calientita.</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-semibold text-lg">üö´ Evitar</p>
                            <p class="text-sm">No tomar caf√© por la tarde.</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-semibold text-lg">üò¥ Rutina de Sue√±o</p>
                            <ul class="list-disc list-inside space-y-2 mt-2">
                                <li>No usar tel√©fonos ni televisor 1 hora antes de dormir.</li>
                                <li>Tomar un ba√±o de agua tibia despu√©s de la sesi√≥n de pies en agua.</li>
                                <li>Usar ruido blanco u ondas binaurales en YouTube (mantener el dispositivo lejos).</li>
                            </ul>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-semibold text-lg">üß™ Sueroterapia</p>
                            <p class="text-sm">Protocolo 1-3-6: 1 sesi√≥n cada semana por 2-3 semanas, luego al mes, a los 3 meses y a los 6 meses.</p>
                        </div>
                    </div>
                </section>
                
                <!-- Tracker Semanal -->
                <section class="mt-10">
                    <h2 class="section-title text-2xl font-semibold mb-4 text-sky-800">Mi Rastreador de H√°bitos</h2>
                    <p class="mb-4 text-gray-600">Marca con un clic cada d√≠a que completes tu tarea. ¬°Vamos a por ello!</p>
                    <div class="space-y-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-semibold text-lg">üíä Suplementos diarios</p>
                            <div class="grid grid-checkboxes gap-2 mt-2">
                                <span class="text-center text-sm font-medium">Lun</span>
                                <span class="text-center text-sm font-medium">Mar</span>
                                <span class="text-center text-sm font-medium">Mi√©</span>
                                <span class="text-center text-sm font-medium">Jue</span>
                                <span class="text-center text-sm font-medium">Vie</span>
                                <span class="text-center text-sm font-medium">S√°b</span>
                                <span class="text-center text-sm font-medium">Dom</span>
                                <!-- Checkboxes here -->
                                <div class="btn-check" data-id="suplementos-0"></div>
                                <div class="btn-check" data-id="suplementos-1"></div>
                                <div class="btn-check" data-id="suplementos-2"></div>
                                <div class="btn-check" data-id="suplementos-3"></div>
                                <div class="btn-check" data-id="suplementos-4"></div>
                                <div class="btn-check" data-id="suplementos-5"></div>
                                <div class="btn-check" data-id="suplementos-6"></div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-semibold text-lg">üèÉ‚Äç‚ôÄÔ∏è Ejercicio (Fuerza + Cardio)</p>
                            <div class="grid grid-checkboxes gap-2 mt-2">
                                <span class="text-center text-sm font-medium">Lun</span>
                                <span class="text-center text-sm font-medium">Mar</span>
                                <span class="text-center text-sm font-medium">Mi√©</span>
                                <span class="text-center text-sm font-medium">Jue</span>
                                <span class="text-center text-sm font-medium">Vie</span>
                                <span class="text-center text-sm font-medium">S√°b</span>
                                <span class="text-center text-sm font-medium">Dom</span>
                                <!-- Checkboxes here -->
                                <div class="btn-check" data-id="ejercicio-0"></div>
                                <div class="btn-check" data-id="ejercicio-1"></div>
                                <div class="btn-check" data-id="ejercicio-2"></div>
                                <div class="btn-check" data-id="ejercicio-3"></div>
                                <div class="btn-check" data-id="ejercicio-4"></div>
                                <div class="btn-check" data-id="ejercicio-5"></div>
                                <div class="btn-check" data-id="ejercicio-6"></div>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <p class="font-semibold text-lg">üò¥ Rutina de Sue√±o</p>
                            <div class="grid grid-checkboxes gap-2 mt-2">
                                <span class="text-center text-sm font-medium">Lun</span>
                                <span class="text-center text-sm font-medium">Mar</span>
                                <span class="text-center text-sm font-medium">Mi√©</span>
                                <span class="text-center text-sm font-medium">Jue</span>
                                <span class="text-center text-sm font-medium">Vie</span>
                                <span class="text-center text-sm font-medium">S√°b</span>
                                <span class="text-center text-sm font-medium">Dom</span>
                                <!-- Checkboxes here -->
                                <div class="btn-check" data-id="sue√±o-0"></div>
                                <div class="btn-check" data-id="sue√±o-1"></div>
                                <div class="btn-check" data-id="sue√±o-2"></div>
                                <div class="btn-check" data-id="sue√±o-3"></div>
                                <div class="btn-check" data-id="sue√±o-4"></div>
                                <div class="btn-check" data-id="sue√±o-5"></div>
                                <div class="btn-check" data-id="sue√±o-6"></div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Chatbot de Suplementos -->
                <section class="mt-10">
                    <h2 class="section-title text-2xl font-semibold mb-4 text-sky-800">Asistente de Suplementos ‚ú®</h2>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="chat-container space-y-4 mb-4" id="chat-messages">
                            <div class="gemini-message">
                                <p>Hola, soy tu asistente virtual. Puedes preguntarme sobre tus suplementos, por ejemplo: "¬øPara qu√© sirve el Omega 3?"</p>
                            </div>
                        </div>
                        <div class="flex">
                            <input type="text" id="chat-input" placeholder="Escribe tu pregunta aqu√≠..." class="flex-grow rounded-lg p-2 border border-gray-300 mr-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <button id="send-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300">
                                Enviar
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-red-500 mt-2">‚ö†Ô∏è **Aviso Importante:** Este asistente es una herramienta informativa. Para cualquier decisi√≥n m√©dica, siempre consulta a tu doctor o profesional de la salud.</p>
                </section>

            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const checkboxes = document.querySelectorAll('.btn-check');
            checkboxes.forEach(checkbox => {
                const id = checkbox.getAttribute('data-id');
                const isChecked = localStorage.getItem(id) === 'true';
                if (isChecked) {
                    checkbox.classList.add('checked');
                }

                checkbox.addEventListener('click', () => {
                    const isNowChecked = checkbox.classList.toggle('checked');
                    localStorage.setItem(id, isNowChecked);
                });
            });

            // C√≥digo para el chatbot y TTS con la API de Gemini
            
            const apiKey = "";
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            const chatMessages = document.getElementById('chat-messages');

            // --- Funcionalidad del Chatbot ---
            const chatHistory = [{
                role: "user",
                parts: [{ text: "Act√∫a como un asistente m√©dico experto en medicina integrativa. Tu √∫nica funci√≥n es responder preguntas sobre suplementos nutricionales y sus funciones, bas√°ndote en la informaci√≥n proporcionada en el plan de bienestar. Proporciona una respuesta clara y concisa, sin dar consejos m√©dicos o diagn√≥sticos. S√© siempre positivo y alentador. Si la pregunta no est√° relacionada con los suplementos de este plan, responde amablemente que solo puedes ayudar con la informaci√≥n del tratamiento." }]
            }];

            const sendMessage = async () => {
                const userMessage = chatInput.value.trim();
                if (userMessage === '') return;

                // A√±adir el mensaje del usuario al chat
                const userMsgDiv = document.createElement('div');
                userMsgDiv.className = 'user-message text-right';
                userMsgDiv.innerHTML = `<p>${userMessage}</p>`;
                chatMessages.appendChild(userMsgDiv);

                chatInput.value = '';
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Mostrar el indicador de carga
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'gemini-message flex items-center';
                loadingDiv.innerHTML = `<p class="flex items-center"><span class="loading-dot w-1 h-1 bg-blue-500 rounded-full mr-1"></span><span class="loading-dot w-1 h-1 bg-blue-500 rounded-full mr-1"></span><span class="loading-dot w-1 h-1 bg-blue-500 rounded-full"></span></p>`;
                chatMessages.appendChild(loadingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{ role: "user", parts: [{ text: userMessage }] }],
                    systemInstruction: {
                        parts: [{ text: "Eres un asistente m√©dico experto en medicina integrativa y te basas en el plan de bienestar. Tus √∫nicas funciones son responder preguntas sobre suplementos nutricionales y sus funciones. La informaci√≥n del plan es: Omega 3, Coenzima Q10, Belle Vie, Cardo Mariano, Resveratrol, Vit D3, K2, Ashwagandha, Terapia de Bach. Si la pregunta no est√° relacionada con estos, responde amablemente que solo puedes ayudar con la informaci√≥n de tu tratamiento." }]
                    },
                };
                
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    const geminiText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                    loadingDiv.remove();
                    
                    if (geminiText) {
                        const geminiMsgDiv = document.createElement('div');
                        geminiMsgDiv.className = 'gemini-message';
                        geminiMsgDiv.innerHTML = `<p>${geminiText}</p>`;
                        chatMessages.appendChild(geminiMsgDiv);
                    } else {
                        const errorMsgDiv = document.createElement('div');
                        errorMsgDiv.className = 'gemini-message text-red-500';
                        errorMsgDiv.innerHTML = '<p>Lo siento, hubo un error al obtener la respuesta. Por favor, int√©ntalo de nuevo.</p>';
                        chatMessages.appendChild(errorMsgDiv);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    loadingDiv.remove();
                    const errorMsgDiv = document.createElement('div');
                    errorMsgDiv.className = 'gemini-message text-red-500';
                    errorMsgDiv.innerHTML = '<p>Lo siento, hubo un error al comunicarse con el servicio. Por favor, int√©ntalo de nuevo.</p>';
                    chatMessages.appendChild(errorMsgDiv);
                }
                chatMessages.scrollTop = chatMessages.scrollHeight;
            };

            sendBtn.addEventListener('click', sendMessage);
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // --- Funcionalidad del Text-to-Speech (TTS) ---

            const speakButtons = document.querySelectorAll('.speak-btn');
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            const base64ToArrayBuffer = (base64) => {
                const binaryString = atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            };

            const pcmToWav = (pcmData, sampleRate) => {
                const dataLength = pcmData.length * 2;
                const buffer = new ArrayBuffer(44 + dataLength);
                const view = new DataView(buffer);
                let offset = 0;

                const writeString = (str) => {
                    for (let i = 0; i < str.length; i++) {
                        view.setUint8(offset + i, str.charCodeAt(i));
                    }
                    offset += str.length;
                };

                const writeUint32 = (val) => {
                    view.setUint32(offset, val, true);
                    offset += 4;
                };

                const writeUint16 = (val) => {
                    view.setUint16(offset, val, true);
                    offset += 2;
                };

                // RIFF chunk
                writeString('RIFF');
                writeUint32(36 + dataLength);
                writeString('WAVE');

                // fmt chunk
                writeString('fmt ');
                writeUint32(16);
                writeUint16(1); // PCM format
                writeUint16(1); // Mono
                writeUint32(sampleRate);
                writeUint32(sampleRate * 2); // Byte rate
                writeUint16(2); // Block align
                writeUint16(16); // Bits per sample

                // data chunk
                writeString('data');
                writeUint32(dataLength);

                const pcm16 = new Int16Array(pcmData);
                for (let i = 0; i < pcm16.length; i++) {
                    view.setInt16(offset, pcm16[i], true);
                    offset += 2;
                }
                return new Blob([view], { type: 'audio/wav' });
            };

            const speakText = async (text, button) => {
                button.disabled = true;
                const originalText = button.innerHTML;
                button.innerHTML = 'Cargando...';

                try {
                    const payload = {
                        contents: [{
                            parts: [{ text: text }]
                        }],
                        generationConfig: {
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: { voiceName: "Kore" }
                                }
                            }
                        },
                        model: "gemini-2.5-flash-preview-tts"
                    };

                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    const audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    const mimeType = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType;

                    if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                        const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                        if (!sampleRateMatch) {
                            throw new Error("Sample rate not found in MIME type.");
                        }
                        const sampleRate = parseInt(sampleRateMatch[1], 10);
                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, sampleRate);
                        const audioUrl = URL.createObjectURL(wavBlob);
                        
                        const audio = new Audio(audioUrl);
                        audio.play();

                        audio.onended = () => {
                            button.innerHTML = originalText;
                            button.disabled = false;
                            URL.revokeObjectURL(audioUrl);
                        };
                    } else {
                        throw new Error("No audio data or invalid format.");
                    }
                } catch (error) {
                    console.error('Error en el TTS:', error);
                    button.innerHTML = 'Error';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }, 2000);
                }
            };

            speakButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const textToSpeak = button.getAttribute('data-text');
                    speakText(textToSpeak, button);
                });
            });
        });
    </script>
</body>
</html>
